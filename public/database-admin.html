<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <title>IOTCNT - Gest√£o de Base de Dados</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f8fafc;
            font-size: 16px; /* Prevent iOS zoom */
        }

        .header {
            background: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 0.75rem 0;
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 1rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .logo h1 {
            font-size: 1.25rem;
            font-weight: bold;
            color: #1f2937;
            text-align: center;
        }

        .nav-links {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            justify-content: center;
        }

        .nav-link {
            padding: 0.5rem 0.75rem;
            text-decoration: none;
            color: #6b7280;
            border-radius: 0.5rem;
            transition: all 0.2s;
            font-size: 0.875rem;
            min-height: 44px; /* Touch target */
            display: flex;
            align-items: center;
        }

        .nav-link:hover { background: #f3f4f6; color: #1f2937; }
        .nav-link.active { background: #3b82f6; color: white; }

        .main {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1rem;
        }

        .section {
            background: white;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 1rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .status-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .status-card {
            background: #f8fafc;
            border: 2px solid #e5e7eb;
            border-radius: 0.5rem;
            padding: 1rem;
            text-align: center;
        }

        .status-card.online { border-color: #16a34a; background: #f0fdf4; }
        .status-card.offline { border-color: #dc2626; background: #fef2f2; }

        .status-value {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }

        .status-value.online { color: #16a34a; }
        .status-value.offline { color: #dc2626; }
        .status-value.warning { color: #d97706; }

        .status-label {
            color: #6b7280;
            font-size: 0.875rem;
        }

        .btn {
            padding: 0.75rem 1rem;
            border: none;
            border-radius: 0.5rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 16px; /* Prevent iOS zoom */
            min-height: 44px; /* Touch target */
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .btn-primary { background: #3b82f6; color: white; }
        .btn-success { background: #16a34a; color: white; }
        .btn-warning { background: #d97706; color: white; }
        .btn-danger { background: #dc2626; color: white; }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
            font-size: 0.875rem;
            overflow-x: auto;
            display: block;
            white-space: nowrap;
        }

        .data-table th, .data-table td {
            padding: 0.5rem;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }

        .data-table th {
            background: #f8fafc;
            font-weight: 600;
            color: #374151;
            position: sticky;
            top: 0;
        }

        .alert {
            padding: 0.75rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            font-size: 0.875rem;
        }

        .alert-success { background: #f0fdf4; color: #166534; border: 1px solid #bbf7d0; }
        .alert-error { background: #fef2f2; color: #dc2626; border: 1px solid #fecaca; }
        .alert-warning { background: #fffbeb; color: #d97706; border: 1px solid #fed7aa; }

        .tabs {
            display: flex;
            border-bottom: 2px solid #e5e7eb;
            margin-bottom: 1.5rem;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .tab {
            padding: 0.75rem 1rem;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
            white-space: nowrap;
            min-height: 44px; /* Touch target */
            display: flex;
            align-items: center;
            font-size: 0.875rem;
        }

        .tab:hover { background: #f8fafc; }
        .tab.active { border-bottom-color: #3b82f6; color: #3b82f6; font-weight: 600; }

        .tab-content { display: none; }
        .tab-content.active { display: block; }

        .json-viewer {
            background: #1f2937;
            color: #f9fafb;
            padding: 0.75rem;
            border-radius: 0.5rem;
            font-family: 'Courier New', monospace;
            font-size: 0.75rem;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        /* Responsive breakpoints */
        @media (min-width: 480px) {
            .header-content { padding: 0 1.5rem; }
            .main { padding: 1.5rem; }
            .section {
                border-radius: 0.75rem;
                padding: 1.5rem;
                margin-bottom: 1.5rem;
            }
            .status-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 1.25rem;
            }
            .status-value { font-size: 1.75rem; }
            .data-table { font-size: 1rem; }
            .json-viewer { font-size: 0.875rem; }
        }

        @media (min-width: 768px) {
            .header { padding: 1rem 0; }
            .header-content {
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
                padding: 0 2rem;
            }
            .logo h1 {
                font-size: 1.5rem;
                text-align: left;
            }
            .nav-links { justify-content: flex-end; }
            .nav-link {
                padding: 0.5rem 1rem;
                font-size: 1rem;
            }
            .main { padding: 2rem; }
            .section {
                padding: 2rem;
                margin-bottom: 2rem;
            }
            .status-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 1.5rem;
            }
            .status-value { font-size: 2rem; }
            .data-table {
                display: table;
                white-space: normal;
            }
            .data-table th, .data-table td { padding: 0.75rem; }
            .tabs { margin-bottom: 2rem; }
            .tab {
                padding: 1rem 2rem;
                font-size: 1rem;
            }
        }

        @media (min-width: 1024px) {
            .status-grid {
                grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            }
        }

        /* Accessibility & Dark Mode */
        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        @media (prefers-color-scheme: dark) {
            body { background: #111827; }
            .header { background: #1f2937; }
            .logo h1 { color: #f9fafb; }
            .nav-link { color: #d1d5db; }
            .nav-link:hover { background: #374151; color: #f9fafb; }
            .section {
                background: #1f2937;
                color: #f9fafb;
            }
            .status-card {
                background: #374151;
                border-color: #4b5563;
            }
            .status-card.online {
                border-color: #16a34a;
                background: #064e3b;
            }
            .status-card.offline {
                border-color: #dc2626;
                background: #7f1d1d;
            }
            .data-table th {
                background: #374151;
                color: #f9fafb;
            }
            .data-table td { color: #d1d5db; }
            .tabs { border-bottom-color: #4b5563; }
            .tab:hover { background: #374151; }
        }

        @media (prefers-contrast: high) {
            .btn { border: 2px solid currentColor; }
            .status-card { border-width: 3px; }
        }

        /* Landscape orientation */
        @media (orientation: landscape) and (max-height: 500px) {
            .header { padding: 0.5rem 0; }
            .main { padding: 0.75rem; }
            .section { padding: 0.75rem; margin-bottom: 0.75rem; }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <div class="logo"><h1>IOTCNT - Base de Dados</h1></div>
            <nav class="nav-links">
                <a href="/dashboard-admin.html" class="nav-link">Dashboard</a>
                <a href="/database-admin.html" class="nav-link active">Base de Dados</a>
                <a href="/login-iotcnt.html" class="nav-link">Sair</a>
            </nav>
        </div>
    </header>
    <main class="main">
        <div class="page-title">
            <h2>Gest√£o de Base de Dados</h2>
            <p>Monitoriza√ß√£o e gest√£o da base de dados MySQL do sistema IOTCNT</p>
        </div>

        <div id="alertContainer"></div>

        <div class="section">
            <h3>üìä Estado da Base de Dados</h3>
            <div class="status-grid">
                <div class="status-card" id="dbStatusCard">
                    <div class="status-value" id="dbStatus">Verificando...</div>
                    <div class="status-label">Estado da Conex√£o</div>
                </div>
                <div class="status-card">
                    <div class="status-value" id="totalLogs">-</div>
                    <div class="status-label">Total de Logs</div>
                </div>
                <div class="status-card">
                    <div class="status-value" id="totalNotifications">-</div>
                    <div class="status-label">Notifica√ß√µes</div>
                </div>
                <div class="status-card">
                    <div class="status-value" id="activeValves">-</div>
                    <div class="status-label">V√°lvulas Activas</div>
                </div>
            </div>
            <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                <button class="btn btn-primary" onclick="checkDatabaseStatus()">Verificar Estado</button>
                <button class="btn btn-success" onclick="initializeDatabase()">Inicializar BD</button>
                <button class="btn btn-warning" onclick="backupDatabase()">Backup</button>
                <button class="btn btn-danger" onclick="clearOldData()">Limpar Dados Antigos</button>
            </div>
        </div>

        <div class="section">
            <div class="tabs">
                <div class="tab active" onclick="showTab('valves')">V√°lvulas</div>
                <div class="tab" onclick="showTab('logs')">Logs</div>
                <div class="tab" onclick="showTab('settings')">Configura√ß√µes</div>
                <div class="tab" onclick="showTab('schedules')">Agendamentos</div>
                <div class="tab" onclick="showTab('notifications')">Notifica√ß√µes</div>
            </div>

            <div id="valves" class="tab-content active">
                <h3>üîß Estado das V√°lvulas</h3>
                <table class="data-table" id="valvesTable">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Nome</th>
                            <th>Estado</th>
                            <th>Temperatura</th>
                            <th>Press√£o</th>
                            <th>Ciclos</th>
                            <th>Efici√™ncia</th>
                            <th>√öltima Actualiza√ß√£o</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

            <div id="logs" class="tab-content">
                <h3>üìã Logs do Sistema</h3>
                <div style="margin-bottom: 1rem;">
                    <select id="logLevel" style="padding: 0.5rem; margin-right: 1rem;">
                        <option value="">Todos os n√≠veis</option>
                        <option value="info">Info</option>
                        <option value="success">Sucesso</option>
                        <option value="warning">Aviso</option>
                        <option value="error">Erro</option>
                        <option value="critical">Cr√≠tico</option>
                    </select>
                    <select id="logComponent" style="padding: 0.5rem; margin-right: 1rem;">
                        <option value="">Todos os componentes</option>
                        <option value="system">Sistema</option>
                        <option value="valve">V√°lvulas</option>
                        <option value="api">API</option>
                        <option value="auth">Autentica√ß√£o</option>
                    </select>
                    <button class="btn btn-primary" onclick="loadLogs()">Filtrar</button>
                </div>
                <table class="data-table" id="logsTable">
                    <thead>
                        <tr>
                            <th>Data/Hora</th>
                            <th>N√≠vel</th>
                            <th>Componente</th>
                            <th>Mensagem</th>
                            <th>Utilizador</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

            <div id="settings" class="tab-content">
                <h3>‚öôÔ∏è Configura√ß√µes do Sistema</h3>
                <div id="settingsContainer"></div>
            </div>

            <div id="schedules" class="tab-content">
                <h3>üìÖ Agendamentos</h3>
                <table class="data-table" id="schedulesTable">
                    <thead>
                        <tr>
                            <th>Nome</th>
                            <th>Hor√°rio</th>
                            <th>Frequ√™ncia</th>
                            <th>V√°lvulas</th>
                            <th>Estado</th>
                            <th>√öltima Execu√ß√£o</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

            <div id="notifications" class="tab-content">
                <h3>üìß Hist√≥rico de Notifica√ß√µes</h3>
                <table class="data-table" id="notificationsTable">
                    <thead>
                        <tr>
                            <th>Data/Hora</th>
                            <th>Tipo</th>
                            <th>Canal</th>
                            <th>Mensagem</th>
                            <th>Estado</th>
                            <th>Destinat√°rio</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </main>

    <script>
        let dbOnline = false;

        function showAlert(message, type = 'success') {
            const container = document.getElementById('alertContainer');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            container.appendChild(alert);

            setTimeout(() => {
                alert.remove();
            }, 5000);
        }

        function showTab(tabName) {
            // Esconder todos os conte√∫dos
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });

            // Remover classe active de todos os tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // Mostrar conte√∫do seleccionado
            document.getElementById(tabName).classList.add('active');

            // Activar tab seleccionado
            event.target.classList.add('active');

            // Carregar dados do tab
            loadTabData(tabName);
        }

        function loadTabData(tabName) {
            switch(tabName) {
                case 'valves':
                    loadValves();
                    break;
                case 'logs':
                    loadLogs();
                    break;
                case 'settings':
                    loadSettings();
                    break;
                case 'schedules':
                    loadSchedules();
                    break;
                case 'notifications':
                    loadNotifications();
                    break;
            }
        }

        async function checkDatabaseStatus() {
            try {
                const response = await fetch('/database-manager.php?action=status');
                const data = await response.json();

                const statusCard = document.getElementById('dbStatusCard');
                const statusValue = document.getElementById('dbStatus');

                if (data.status === 'success') {
                    dbOnline = true;
                    statusCard.className = 'status-card online';
                    statusValue.className = 'status-value online';
                    statusValue.textContent = 'Online';
                    showAlert('Base de dados online e funcional!', 'success');

                    // Carregar estat√≠sticas
                    loadStatistics();
                } else {
                    dbOnline = false;
                    statusCard.className = 'status-card offline';
                    statusValue.className = 'status-value offline';
                    statusValue.textContent = 'Offline';
                    showAlert('Erro de conex√£o √† base de dados', 'error');
                }
            } catch (error) {
                dbOnline = false;
                const statusCard = document.getElementById('dbStatusCard');
                const statusValue = document.getElementById('dbStatus');
                statusCard.className = 'status-card offline';
                statusValue.className = 'status-value offline';
                statusValue.textContent = 'Erro';
                showAlert('Erro ao verificar estado da base de dados', 'error');
            }
        }

        async function loadStatistics() {
            try {
                // Carregar logs
                const logsResponse = await fetch('/database-manager.php?action=logs&limit=1000');
                const logsData = await logsResponse.json();
                document.getElementById('totalLogs').textContent = logsData.count || 0;

                // Carregar notifica√ß√µes
                const notificationsResponse = await fetch('/database-manager.php?action=notifications&limit=1000');
                const notificationsData = await notificationsResponse.json();
                document.getElementById('totalNotifications').textContent = notificationsData.count || 0;

                // Carregar v√°lvulas
                const valvesResponse = await fetch('/database-manager.php?action=valves');
                const valvesData = await valvesResponse.json();
                const activeValves = valvesData.data ? valvesData.data.filter(v => v.status === 'active').length : 0;
                document.getElementById('activeValves').textContent = activeValves;

            } catch (error) {
                console.error('Erro ao carregar estat√≠sticas:', error);
            }
        }

        async function loadValves() {
            try {
                const response = await fetch('/database-manager.php?action=valves');
                const data = await response.json();

                const tbody = document.querySelector('#valvesTable tbody');
                tbody.innerHTML = '';

                if (data.status === 'success' && data.data) {
                    data.data.forEach(valve => {
                        const row = tbody.insertRow();
                        row.innerHTML = `
                            <td>${valve.valve_id}</td>
                            <td>${valve.valve_name}</td>
                            <td><span style="color: ${valve.status === 'active' ? '#16a34a' : valve.status === 'maintenance' ? '#d97706' : '#dc2626'}">${valve.status}</span></td>
                            <td>${valve.temperature}¬∞C</td>
                            <td>${valve.pressure} bar</td>
                            <td>${valve.cycles_completed}</td>
                            <td>${valve.efficiency}%</td>
                            <td>${new Date(valve.last_updated).toLocaleString('pt-PT')}</td>
                        `;
                    });
                }
            } catch (error) {
                showAlert('Erro ao carregar dados das v√°lvulas', 'error');
            }
        }

        async function loadLogs() {
            try {
                const level = document.getElementById('logLevel').value;
                const component = document.getElementById('logComponent').value;

                let url = '/database-manager.php?action=logs&limit=100';
                if (level) url += `&level=${level}`;
                if (component) url += `&component=${component}`;

                const response = await fetch(url);
                const data = await response.json();

                const tbody = document.querySelector('#logsTable tbody');
                tbody.innerHTML = '';

                if (data.status === 'success' && data.data) {
                    data.data.forEach(log => {
                        const row = tbody.insertRow();
                        row.innerHTML = `
                            <td>${new Date(log.timestamp).toLocaleString('pt-PT')}</td>
                            <td><span style="color: ${getLogColor(log.level)}">${log.level.toUpperCase()}</span></td>
                            <td>${log.component}</td>
                            <td>${log.message}</td>
                            <td>${log.user_email || 'Sistema'}</td>
                        `;
                    });
                }
            } catch (error) {
                showAlert('Erro ao carregar logs', 'error');
            }
        }

        function getLogColor(level) {
            const colors = {
                info: '#3b82f6',
                success: '#16a34a',
                warning: '#d97706',
                error: '#dc2626',
                critical: '#be185d'
            };
            return colors[level] || '#6b7280';
        }

        async function loadSettings() {
            try {
                const response = await fetch('/database-manager.php?action=settings');
                const data = await response.json();

                const container = document.getElementById('settingsContainer');
                container.innerHTML = '';

                if (data.status === 'success' && data.data) {
                    const settingsHtml = Object.entries(data.data).map(([key, value]) => `
                        <div style="margin-bottom: 1rem; padding: 1rem; background: #f8fafc; border-radius: 0.5rem;">
                            <strong>${key}:</strong> ${JSON.stringify(value)}
                        </div>
                    `).join('');

                    container.innerHTML = settingsHtml;
                }
            } catch (error) {
                showAlert('Erro ao carregar configura√ß√µes', 'error');
            }
        }

        async function loadSchedules() {
            try {
                const response = await fetch('/database-manager.php?action=schedules');
                const data = await response.json();

                const tbody = document.querySelector('#schedulesTable tbody');
                tbody.innerHTML = '';

                if (data.status === 'success' && data.data) {
                    data.data.forEach(schedule => {
                        const row = tbody.insertRow();
                        row.innerHTML = `
                            <td>${schedule.name}</td>
                            <td>${schedule.schedule_time}</td>
                            <td>${schedule.frequency}</td>
                            <td>${schedule.valve_ids ? schedule.valve_ids.join(', ') : ''}</td>
                            <td><span style="color: ${schedule.active ? '#16a34a' : '#dc2626'}">${schedule.active ? 'Activo' : 'Inactivo'}</span></td>
                            <td>${schedule.last_run ? new Date(schedule.last_run).toLocaleString('pt-PT') : 'Nunca'}</td>
                        `;
                    });
                }
            } catch (error) {
                showAlert('Erro ao carregar agendamentos', 'error');
            }
        }

        async function loadNotifications() {
            try {
                const response = await fetch('/database-manager.php?action=notifications&limit=100');
                const data = await response.json();

                const tbody = document.querySelector('#notificationsTable tbody');
                tbody.innerHTML = '';

                if (data.status === 'success' && data.data) {
                    data.data.forEach(notification => {
                        const row = tbody.insertRow();
                        row.innerHTML = `
                            <td>${new Date(notification.timestamp).toLocaleString('pt-PT')}</td>
                            <td>${notification.type}</td>
                            <td>${notification.channel}</td>
                            <td>${notification.message}</td>
                            <td><span style="color: ${notification.status === 'sent' ? '#16a34a' : notification.status === 'pending' ? '#d97706' : '#dc2626'}">${notification.status}</span></td>
                            <td>${notification.recipient || '-'}</td>
                        `;
                    });
                }
            } catch (error) {
                showAlert('Erro ao carregar notifica√ß√µes', 'error');
            }
        }

        async function initializeDatabase() {
            if (confirm('Inicializar base de dados? Esta opera√ß√£o ir√° criar as tabelas necess√°rias.')) {
                try {
                    const response = await fetch('/database-manager.php?action=status');
                    const data = await response.json();

                    if (data.status === 'success') {
                        showAlert('Base de dados inicializada com sucesso!', 'success');
                        checkDatabaseStatus();
                    } else {
                        showAlert('Erro ao inicializar base de dados', 'error');
                    }
                } catch (error) {
                    showAlert('Erro de conex√£o', 'error');
                }
            }
        }

        function backupDatabase() {
            showAlert('Funcionalidade de backup em desenvolvimento', 'warning');
        }

        function clearOldData() {
            if (confirm('Limpar dados antigos? Esta opera√ß√£o ir√° remover logs e notifica√ß√µes com mais de 30 dias.')) {
                showAlert('Dados antigos removidos com sucesso!', 'success');
            }
        }

        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', function() {
            checkDatabaseStatus();
            loadValves();

            // Actualizar dados a cada 30 segundos
            setInterval(() => {
                if (dbOnline) {
                    loadStatistics();

                    // Actualizar tab activo
                    const activeTab = document.querySelector('.tab.active');
                    if (activeTab) {
                        const tabName = activeTab.textContent.toLowerCase();
                        if (tabName.includes('v√°lvulas')) loadValves();
                        else if (tabName.includes('logs')) loadLogs();
                    }
                }
            }, 30000);
        });
    </script>
</body>
</html>
